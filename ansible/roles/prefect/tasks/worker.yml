#- name: Crear servicio systemd para Prefect Worker
#  copy:
#    dest: /etc/systemd/system/prefect-worker.service
#    content: |
#      [Unit]
#      Description=Prefect Worker
#      After=network.target

#      [Service]
#      Type=simple
#      User=debian
#      Group=debian
#      WorkingDirectory=/home/debian
#      Environment="PREFECT_API_URL=http://{{ ansible_host }}:4200/api"
#      ExecStart=/home/debian/.venv_prefect/bin/prefect worker start -p default-agent-pool
#      Restart=always
#      RestartSec=5s

#      [Install]
#      WantedBy=multi-user.target

- name: Crear Docker Work Pool en Prefect
  become: false
  environment:
    PATH: "/home/debian/.venv_prefect/bin/prefect"
    PREFECT_API_URL: "http://{{ ansible_host }}:4200/api"
  shell: |
    source /home/debian/.venv_prefect/bin/activate
    prefect config set PREFECT_API_URL=http://{{ ansible_host }}:4200/api
    prefect work-pool create \
      --type docker \
      default-docker-pool
  args:
    executable: /bin/bash
  register: create_pool_result
  retries: 5
  delay: 5
  until: create_pool_result is succeeded or "'already exists'" in create_pool_result.stderr
  failed_when: create_pool_result.rc != 0 and "'already exists'" not in create_pool_result.stderr



#- name: Recargar systemd y habilitar Prefect Worker
#  systemd:
#    daemon_reload: true
#    name: prefect-worker
#    enabled: true
#    state: started

- name: Inspeccionar Work Pool en Prefect
  become: false
  environment:
    PATH: "/home/debian/.venv_prefect/bin:{{ ansible_env.PATH }}"
    PREFECT_API_URL: "http://{{ ansible_host }}:4200/api"
  shell: |
    source /home/debian/.venv_prefect/bin/activate
    prefect work-pool inspect default-docker-pool
  args:
    executable: /bin/bash
  register: pool_inspect

- name: Mostrar informaci√≥n del pool
  debug:
    var: pool_inspect.stdout_lines


- name: Iniciar Worker Docker para el Work Pool
  become: false
  environment:
    PATH: "/home/debian/.venv_prefect/bin:{{ ansible_env.PATH }}"
    PREFECT_API_URL: "http://{{ ansible_host }}:4200/api"
  shell: |
    source /home/debian/.venv_prefect/bin/activate
    prefect worker start --pool default-docker-pool --name docker-worker-1
  args:
    executable: /bin/bash
  async: 3600
  poll: 0
  register: worker_start
