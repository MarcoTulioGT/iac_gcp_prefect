- name: Crear symlink para Prefect CLI
  file:
    src: /opt/prefect_venv/bin/prefect
    dest: /usr/local/bin/prefect
    state: link

- name: Configurar PREFECT_API_URL
  shell: |
    prefect config set PREFECT_API_URL=http://{{ ansible_host }}:4200/api
  args:
    executable: /bin/bash

- name: Iniciar Prefect Server en background (systemd)
  become: true
  copy:
    dest: /etc/systemd/system/prefect.service
    content: |
      [Unit]
      Description=Prefect Server
      After=network.target

      [Service]
      Type=simple
      User={{ ansible_user }}
      WorkingDirectory=/home/{{ ansible_user }}
      Environment="PREFECT_API_URL=http://{{ ansible_host }}:4200/api"
      ExecStart=/opt/prefect_venv/bin/prefect server start --host 0.0.0.0
      Restart=always

      [Install]
      WantedBy=multi-user.target

- name: Recargar systemd y habilitar Prefect Server
  become: true
  systemd:
    daemon_reload: true
    name: prefect
    enabled: true
    state: started

- name: Verificar configuración de PREFECT_API_URL
  become: false
  shell: |
    prefect config view | grep PREFECT_API_URL
  register: api_url_check

- debug:
    msg: "PREFECT_API_URL está configurado como: {{ api_url_check.stdout }}"
